import React, { useState } from 'react';
import { CheckCircle2 } from 'lucide-react';

export default function ServiceCompletionGuide() {
  const [selectedOption, setSelectedOption] = useState(null);
  const [servicePrice, setServicePrice] = useState('');
  const [tax, setTax] = useState('');
  const [trustSafetyFee, setTrustSafetyFee] = useState('');
  const [contractorPayout, setContractorPayout] = useState('');
  const [showError, setShowError] = useState(false);

  const options = [
    { text: "Pro did not arrive (No-Show) or arrived but completed no work.", completion: 0 },
    { text: "Pro started work but did very little.", completion: 20 },
    { text: "Pro completed some main work; large portion incomplete.", completion: 40 },
    { text: "Pro completed most work; some unfinished.", completion: 60 },
    { text: "Pro completed quoted work but did not remove debris.", completion: 70 },
    { text: "Pro completed most work; poor quality or small areas missed.", completion: 80 },
    { text: "Pro completed all quoted work to customer satisfaction.", completion: 100 }
  ];

  const handleOptionClick = (index) => {
    if (selectedOption === null) {
      // Check if Service Price and Contractor Payout are filled
      if (!servicePrice.trim() || !contractorPayout.trim()) {
        setShowError(true);
        return;
      }
      setShowError(false);
      setSelectedOption(index);
    }
  };

  const handleUndo = (e) => {
    e.stopPropagation();
    setSelectedOption(null);
  };

  const handleReset = () => {
    setSelectedOption(null);
    setServicePrice('');
    setTax('');
    setTrustSafetyFee('');
    setContractorPayout('');
    setShowError(false);
  };

  const parseAmount = (value) => {
    const num = parseFloat(value.replace(/[^0-9.-]/g, ''));
    return isNaN(num) ? 0 : num;
  };

  const formatCurrency = (value) => {
    if (!value) return '';
    const num = parseAmount(value);
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(num);
  };

  const handleCurrencyInput = (value, setter) => {
    // Allow typing numbers and decimal points
    const cleanValue = value.replace(/[^0-9.]/g, '');
    setter(cleanValue);
  };

  const handleCurrencyBlur = (value, setter) => {
    if (value) {
      setter(formatCurrency(value));
    }
  };

  const handleCurrencyFocus = (value, setter) => {
    // Remove formatting when focused for easier editing
    if (value) {
      const cleanValue = value.replace(/[^0-9.]/g, '');
      setter(cleanValue);
    }
  };

  const calculateCustomerCredit = () => {
    if (selectedOption === null) return 0;
    const total = parseAmount(servicePrice) + parseAmount(tax) + parseAmount(trustSafetyFee);
    const refundPercent = (100 - options[selectedOption].completion) / 100;
    return (total * refundPercent).toFixed(2);
  };

  const calculateProviderDebit = () => {
    if (selectedOption === null) return 0;
    const payout = parseAmount(contractorPayout);
    const refundPercent = (100 - options[selectedOption].completion) / 100;
    return (payout * refundPercent).toFixed(2);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-8">
          <h1 className="text-3xl font-bold text-gray-800 mb-4">
            Additional Service Completion Guide
          </h1>
          
          <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-4">
            <p className="text-sm text-red-700 leading-relaxed">
              <strong>NOTE:</strong> This tool applies to additional service disputes involving partial completion or quality issues reported within 5 days of service completion. Always offer Fix or Return Request first. If the customer does not want the Pro to return, or is still not satisfied after the fix, this tool can be used as a guide.
            </p>
            <p className="text-sm text-red-700 leading-relaxed mt-3">
              Use only when clear evidence supports resolving in favor of the customer. This tool is for guidance only and should not be followed strictly. Agents should still review all evidence before deciding the final refund amount. Do not use if evidence does not support that the service was not completed based on quote details. If you need further assistance on how to resolve the dispute, please reach out to Escalations.
            </p>
          </div>

          <div className="flex justify-end mb-6">
            <button
              onClick={handleReset}
              className="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors shadow-md"
            >
              Reset
            </button>
          </div>
          
          <p className="text-gray-600 mb-8">
            Please select the option that best describes the service completion status.
          </p>

          {showError && (
            <div className="mb-6 p-4 bg-red-100 border-2 border-red-400 rounded-lg">
              <p className="text-red-700 font-semibold">
                ‚ö†Ô∏è Please fill out the Billing Details before selecting an option.
              </p>
            </div>
          )}

          <div className="flex gap-8">
            {/* Left Column - Options */}
            <div className="flex-1 space-y-3">
              {options.map((option, index) => (
                <button
                  key={index}
                  onClick={() => handleOptionClick(index)}
                  disabled={selectedOption !== null && selectedOption !== index}
                  className={`w-full text-left p-4 rounded-lg border-2 transition-all duration-200 ${
                    selectedOption === index
                      ? 'border-green-500 bg-green-50 shadow-md'
                      : selectedOption !== null
                      ? 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed opacity-50'
                      : 'border-gray-300 bg-white hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer'
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1 pr-4">
                      <span>{option.text}</span>
                      {index === 4 && (
                        <div className="text-red-600 text-sm mt-2">
                          NOTE: If you choose this option, make sure "Haul and dispose the debris" is included in the quote details.
                        </div>
                      )}
                    </div>
                    {selectedOption === index && (
                      <div className="flex items-center gap-2 flex-shrink-0">
                        <CheckCircle2 className="w-6 h-6 text-green-600" />
                        <button
                          onClick={handleUndo}
                          className="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 transition-colors text-sm font-medium text-gray-700"
                        >
                          Undo
                        </button>
                      </div>
                    )}
                  </div>
                </button>
              ))}
            </div>

            {/* Right Column - Billing Details, Job Completion and Refund Boxes */}
            <div className="w-96 space-y-6">
              <div className="bg-gray-50 border-4 border-gray-400 rounded-lg p-6 shadow-lg">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Billing Details</h3>
                <div className="space-y-3">
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Service Price
                      </label>
                      <input
                        type="text"
                        value={servicePrice}
                        onChange={(e) => handleCurrencyInput(e.target.value, setServicePrice)}
                        onBlur={(e) => handleCurrencyBlur(e.target.value, setServicePrice)}
                        onFocus={(e) => handleCurrencyFocus(e.target.value, setServicePrice)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="$0.00"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Tax
                      </label>
                      <input
                        type="text"
                        value={tax}
                        onChange={(e) => handleCurrencyInput(e.target.value, setTax)}
                        onBlur={(e) => handleCurrencyBlur(e.target.value, setTax)}
                        onFocus={(e) => handleCurrencyFocus(e.target.value, setTax)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="$0.00"
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Trust & Safety Fee
                      </label>
                      <input
                        type="text"
                        value={trustSafetyFee}
                        onChange={(e) => handleCurrencyInput(e.target.value, setTrustSafetyFee)}
                        onBlur={(e) => handleCurrencyBlur(e.target.value, setTrustSafetyFee)}
                        onFocus={(e) => handleCurrencyFocus(e.target.value, setTrustSafetyFee)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="$0.00"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Contractor Payout
                      </label>
                      <input
                        type="text"
                        value={contractorPayout}
                        onChange={(e) => handleCurrencyInput(e.target.value, setContractorPayout)}
                        onBlur={(e) => handleCurrencyBlur(e.target.value, setContractorPayout)}
                        onFocus={(e) => handleCurrencyFocus(e.target.value, setContractorPayout)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        placeholder="$0.00"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="bg-indigo-50 border-4 border-indigo-400 rounded-lg p-6 text-center shadow-lg">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Job Completion %</h3>
                  <div className="text-4xl font-bold text-indigo-600">
                    {selectedOption !== null ? (
                      `${options[selectedOption].completion}%`
                    ) : (
                      <span className="text-2xl text-gray-500">Pending</span>
                    )}
                  </div>
                </div>

                <div className="bg-red-50 border-4 border-red-400 rounded-lg p-6 text-center shadow-lg">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Refund %</h3>
                  <div className="text-4xl font-bold text-red-600">
                    {selectedOption !== null ? (
                      `${100 - options[selectedOption].completion}%`
                    ) : (
                      <span className="text-2xl text-gray-500">Pending</span>
                    )}
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="bg-green-50 border-4 border-green-400 rounded-lg p-6 text-center shadow-lg">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Customer Credit Amount</h3>
                  <div className="text-3xl font-bold text-green-600">
                    ${calculateCustomerCredit()}
                  </div>
                </div>

                <div className="bg-orange-50 border-4 border-orange-400 rounded-lg p-6 text-center shadow-lg">
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Provider Debit Amount</h3>
                  <div className="text-3xl font-bold text-orange-600">
                    ${calculateProviderDebit()}
                  </div>
                </div>
              </div>

              {selectedOption !== null && (
                <div className="mt-6 space-y-4">
                  {parseFloat(calculateCustomerCredit()) > 75 && (
                    <div className="p-4 bg-purple-100 border-2 border-purple-400 rounded-lg">
                      <p className="text-purple-800 font-semibold text-center">
                        ‚ö†Ô∏è Reminder: Customer credit amount is over $75. Please reach out to Escalations for approval.
                      </p>
                    </div>
                  )}
                  
                  {options[selectedOption].completion === 100 ? (
                    <div className="p-4 bg-green-100 border-2 border-green-400 rounded-lg">
                      <p className="text-green-800 font-semibold text-center">
                        üéâ Awesome! All quoted work was completed.
                      </p>
                    </div>
                  ) : (100 - options[selectedOption].completion) === 100 ? (
                    <div className="p-4 bg-blue-100 border-2 border-blue-400 rounded-lg">
                      <p className="text-blue-800 font-semibold text-center">
                        Full Refund: Please use "Credit/Pull Payout" button in Admin.
                      </p>
                    </div>
                  ) : (
                    <div className="p-4 bg-yellow-100 border-2 border-yellow-400 rounded-lg">
                      <p className="text-yellow-800 font-semibold text-center">
                        Partial Refund: Please manually credit the Customer and manually debit the Pro.
                      </p>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
