<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Additional Service Dispute Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom right, #eff6ff, #e0e7ff);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 80rem;
            margin: 0 auto;
        }
        
        .header {
            margin-bottom: 0.5rem;
        }
        
        h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .description {
            color: #dc2626;
            line-height: 1.6;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .error-box {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 0.5rem;
        }
        
        .error-text {
            color: #dc2626;
            font-weight: 500;
            text-align: center;
        }
        
        .reset-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1.5rem;
        }
        
        .btn-reset {
            padding: 0.5rem 1rem;
            background-color: #dc2626;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-reset:hover {
            background-color: #b91c1c;
        }
        
        .main-content {
            display: flex;
            gap: 1.5rem;
        }
        
        .left-panel {
            flex: 1;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
        
        .right-panel {
            width: 24rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        
        .instruction {
            color: #4b5563;
            margin-bottom: 2rem;
        }
        
        .questions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .question {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1.5rem;
        }
        
        .question:last-child {
            border-bottom: none;
        }
        
        .question.indent {
            margin-left: 2rem;
            padding-left: 1rem;
            border-left: 4px solid #93c5fd;
        }
        
        .question.inactive {
            opacity: 0.4;
        }
        
        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .question.inactive .question-text {
            color: #9ca3af;
        }
        
        .button-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        
        .button-group {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:disabled {
            cursor: not-allowed;
        }
        
        .btn-yes {
            background-color: #22c55e;
            color: white;
        }
        
        .btn-yes:hover:not(:disabled) {
            background-color: #16a34a;
        }
        
        .btn-yes.selected {
            background-color: #16a34a;
        }
        
        .btn-yes:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
        }
        
        .btn-no {
            background-color: #ef4444;
            color: white;
        }
        
        .btn-no:hover:not(:disabled) {
            background-color: #dc2626;
        }
        
        .btn-no.selected {
            background-color: #dc2626;
        }
        
        .btn-no:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
        }
        
        .btn-undo {
            padding: 0.25rem 0.75rem;
            background-color: #9ca3af;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-undo:hover {
            background-color: #6b7280;
        }
        
        .complete-box {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #dbeafe;
            border-radius: 0.5rem;
        }
        
        .complete-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .complete-text {
            color: #374151;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .input-group {
            margin-bottom: 2rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-prefix {
            position: absolute;
            left: 0.75rem;
            top: 0.5rem;
            color: #6b7280;
        }
        
        .input-field {
            width: 100%;
            padding: 0.5rem 0.75rem 0.5rem 1.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .stat-box {
            border-radius: 0.375rem;
            padding: 1rem;
            border: 1px solid;
        }
        
        .stat-box.indigo {
            background-color: #eef2ff;
            border-color: #c7d2fe;
        }
        
        .stat-box.red {
            background-color: #fef2f2;
            border-color: #fecaca;
        }
        
        .stat-box.green {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .stat-box.orange {
            background-color: #fff7ed;
            border-color: #fed7aa;
        }
        
        .stat-value {
            text-align: center;
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-value.indigo {
            color: #4f46e5;
        }
        
        .stat-value.red {
            color: #dc2626;
        }
        
        .stat-value.green {
            color: #16a34a;
        }
        
        .stat-value.orange {
            color: #ea580c;
        }
        
        .stat-pending {
            text-align: center;
            font-size: 1.125rem;
            color: #9ca3af;
        }
        
        .progress-bar {
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s;
        }
        
        .progress-fill.indigo {
            background-color: #4f46e5;
        }
        
        .progress-fill.red {
            background-color: #dc2626;
        }
        
        .subsection-title {
            font-size: 1.125rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        
        .message-box {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid;
        }
        
        .message-box.blue {
            background-color: #dbeafe;
            border-color: #93c5fd;
        }
        
        .message-box.yellow {
            background-color: #fef3c7;
            border-color: #fcd34d;
        }
        
        .message-box.red {
            background-color: #fef2f2;
            border-color: #fecaca;
        }
        
        .message-box.purple {
            background-color: #faf5ff;
            border-color: #d8b4fe;
        }
        
        .message-text {
            text-align: center;
            font-weight: 500;
        }
        
        .message-text.blue {
            color: #1d4ed8;
        }
        
        .message-text.yellow {
            color: #a16207;
        }
        
        .message-text.red {
            color: #b91c1c;
        }
        
        .message-text.purple {
            color: #7c3aed;
        }
    </style>
</head>
<body>
    <div id="app" class="container"></div>

    <script>
        const state = {
            answers: {},
            isComplete: false,
            servicePrice: '',
            tax: '',
            trustSafetyFee: '',
            contractorPayout: '',
            showError: false
        };

        const questions = [
            { id: 1, text: "Did the pro arrive on-site?" },
            { id: 2, text: "Did they start any work?" },
            { id: 3, text: "Was any portion of the main quoted work actually performed?" },
            { id: 4, text: "Was the majority of the agreed scope of work completed?" },
            { id: 5, text: "Were all parts of the main quoted work completed with no remaining incomplete service?" },
            { id: 6, text: "Is Haul and Dispose included in the service?" },
            { id: 6.5, text: "Did the Pro haul away and dispose of the debris?", conditional: true },
            { id: 7, text: "Was the service completed to the customer's satisfaction?" }
        ];

        function handleAnswer(questionId, answer) {
            // Check if Service Price and Contractor Payout are entered
            if (!state.servicePrice || !state.contractorPayout) {
                state.showError = true;
                render();
                return;
            }
            
            state.showError = false;
            state.answers[questionId] = answer;
            
            // Check if assessment should end
            const shouldEnd = (answer === 'no' && (questionId === 1 || questionId === 2 || questionId === 3 || questionId === 4 || questionId === 6 || questionId === 6.5)) || 
                              questionId === 7 ||
                              (questionId === 6.5 && state.answers[5] === 'no'); // End after 6.5 if question 5 was "no"
            
            if (shouldEnd) {
                state.isComplete = true;
            }
            render();
        }

        function handleUndo(questionId) {
            delete state.answers[questionId];
            questions.forEach(q => {
                if (q.id > questionId) {
                    delete state.answers[q.id];
                }
            });
            state.isComplete = false;
            render();
        }

        function resetAssessment() {
            state.answers = {};
            state.isComplete = false;
            state.servicePrice = '';
            state.tax = '';
            state.trustSafetyFee = '';
            state.contractorPayout = '';
            state.showError = false;
            
            // Clear the actual input fields
            const servicePriceInput = document.getElementById('servicePrice');
            const taxInput = document.getElementById('tax');
            const trustSafetyFeeInput = document.getElementById('trustSafetyFee');
            const contractorPayoutInput = document.getElementById('contractorPayout');
            
            if (servicePriceInput) servicePriceInput.value = '';
            if (taxInput) taxInput.value = '';
            if (trustSafetyFeeInput) trustSafetyFeeInput.value = '';
            if (contractorPayoutInput) contractorPayoutInput.value = '';
            
            render();
        }

        function calculateJobCompletion() {
            let percentage = 0;
            const ans = state.answers;
            
            if (ans[1] === undefined) return 0;
            if (ans[1] === 'no') return 0;
            
            if (ans[2] === 'yes') {
                percentage = 20;
            } else if (ans[2] === 'no') {
                return 0;
            }
            
            if (ans[3] === 'yes') {
                percentage = 40;
            } else if (ans[3] === 'no') {
                return 20;
            }
            
            if (ans[4] === 'yes') {
                percentage = 60;
            } else if (ans[4] === 'no') {
                return 40;
            }
            
            if (ans[5] === 'yes') {
                percentage = 80;
            } else if (ans[5] === 'no') {
                if (ans[6] === 'yes') {
                    if (ans[6.5] === 'yes') {
                        return 80;
                    } else if (ans[6.5] === 'no') {
                        return 70;
                    } else {
                        return 60;
                    }
                } else if (ans[6] === 'no') {
                    return 80;
                } else {
                    return 60;
                }
            }
            
            if (ans[7] === 'yes') {
                percentage = 100;
            }
            
            return percentage;
        }

        function isQuestionActive(questionId) {
            const ans = state.answers;
            
            if (questionId === 1) return true;
            
            if (questionId === 2) {
                if (ans[1] === 'no') return false;
                return ans[1] === 'yes';
            }
            
            if (questionId === 3) {
                if (ans[1] === 'no' || ans[2] === 'no') return false;
                return ans[2] === 'yes';
            }
            
            if (questionId === 4) {
                if (ans[1] === 'no' || ans[2] === 'no' || ans[3] === 'no') return false;
                return ans[3] === 'yes';
            }
            
            if (questionId === 5) {
                if (ans[1] === 'no' || ans[2] === 'no' || ans[3] === 'no' || ans[4] === 'no') return false;
                return ans[4] === 'yes';
            }
            
            if (questionId === 6) {
                if (ans[1] === 'no' || ans[2] === 'no' || ans[3] === 'no' || ans[4] === 'no') return false;
                return ans[5] === 'no';
            }
            
            if (questionId === 6.5) {
                if (ans[1] === 'no' || ans[2] === 'no' || ans[3] === 'no' || ans[4] === 'no' || ans[6] === 'no') return false;
                return ans[6] === 'yes';
            }
            
            if (questionId === 7) {
                if (ans[1] === 'no' || ans[2] === 'no' || ans[3] === 'no' || ans[4] === 'no' || ans[5] === 'no' || ans[6] === 'no' || ans[6.5] === 'no') return false;
                if (ans[5] === 'yes') return true;
                if (ans[6] === 'yes' && ans[6.5] === 'yes') return true;
                return false;
            }
            
            return false;
        }

        function parseNumber(value) {
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function render() {
            const jobCompletion = calculateJobCompletion();
            const refundPercentage = 100 - jobCompletion;
            const customerCreditAmount = (parseNumber(state.servicePrice) + parseNumber(state.tax) + parseNumber(state.trustSafetyFee)) * (refundPercentage / 100);
            const providerDebitAmount = parseNumber(state.contractorPayout) * (refundPercentage / 100);

            const currentInputs = {
                servicePrice: document.getElementById('servicePrice')?.value || state.servicePrice,
                tax: document.getElementById('tax')?.value || state.tax,
                trustSafetyFee: document.getElementById('trustSafetyFee')?.value || state.trustSafetyFee,
                contractorPayout: document.getElementById('contractorPayout')?.value || state.contractorPayout
            };

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <h1>Additional Service Dispute Assessment</h1>
                </div>
                <p class="description">
                    This tool applies to additional services when there is a dispute about partial completion or quality. Always offer Fix or Return Request first. If the customer does not want the Pro to return, or is still not satisfied after the fix, this tool can be used as a guide.<br><br>
                    Use only when clear evidence supports resolving in favor of the customer. This tool is for guidance only and should not be followed strictly. Agents should still review all evidence before deciding the final refund amount. Do not use if evidence does not support that the service was not completed based on quote details. If you need further assistance on how to resolve the dispute, please reach out to Escalations.
                </p>
                <div class="reset-row">
                    <button onclick="resetAssessment()" class="btn-reset">Reset</button>
                </div>
                
                <div class="main-content">
                    <div class="left-panel">
                        ${state.showError ? `
                            <div class="error-box">
                                <p class="error-text">
                                    Billing Details must be completed before answering the questions.
                                </p>
                            </div>
                        ` : ''}
                        
                        <p class="instruction">
                            Please answer the following questions to assess your dispute.
                        </p>

                        <div class="questions">
                            ${questions.map(q => {
                                const isActive = isQuestionActive(q.id);
                                const answer = state.answers[q.id];
                                const isDisabled = !isActive || answer !== undefined;
                                return `
                                    <div class="question ${q.id === 6.5 ? 'indent' : ''} ${!isActive ? 'inactive' : ''}">
                                        <p class="question-text">
                                            ${q.id}. ${q.text}
                                        </p>
                                        
                                        <div class="button-row">
                                            <div class="button-group">
                                                <button 
                                                    onclick="handleAnswer(${q.id}, 'yes')"
                                                    class="btn btn-yes ${answer === 'yes' ? 'selected' : ''} ${isDisabled && answer !== 'yes' ? 'disabled' : ''}"
                                                    ${isDisabled && answer !== 'yes' ? 'disabled' : ''}>
                                                    Yes
                                                </button>
                                                
                                                <button 
                                                    onclick="handleAnswer(${q.id}, 'no')"
                                                    class="btn btn-no ${answer === 'no' ? 'selected' : ''} ${isDisabled && answer !== 'no' ? 'disabled' : ''}"
                                                    ${isDisabled && answer !== 'no' ? 'disabled' : ''}>
                                                    No
                                                </button>
                                            </div>
                                            
                                            ${answer !== undefined ? `
                                                <button onclick="handleUndo(${q.id})" class="btn-undo">Undo</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${state.isComplete ? `
                            <div class="complete-box">
                                <h2 class="complete-title">Assessment Complete</h2>
                                <p class="complete-text">
                                    ${Object.keys(state.answers).some(key => {
                                        const qId = parseFloat(key);
                                        return state.answers[qId] === 'no' && (qId === 1 || qId === 2 || qId === 3 || qId === 4 || qId === 6 || qId === 6.5);
                                    })
                                        ? "The assessment has been concluded based on your responses."
                                        : "Thank you for completing all questions."}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="right-panel">
                        <h2 class="section-title">Billing Details</h2>
                        
                        <div class="grid-2 input-group">
                            <div>
                                <label class="input-label">Service Price</label>
                                <div class="input-wrapper">
                                    <span class="input-prefix">$</span>
                                    <input type="number" id="servicePrice" value="${currentInputs.servicePrice}" onchange="state.servicePrice = this.value; render();" placeholder="0.00" step="0.01" class="input-field" />
                                </div>
                            </div>
                            <div>
                                <label class="input-label">Tax</label>
                                <div class="input-wrapper">
                                    <span class="input-prefix">$</span>
                                    <input type="number" id="tax" value="${currentInputs.tax}" onchange="state.tax = this.value; render();" placeholder="0.00" step="0.01" class="input-field" />
                                </div>
                            </div>
                            <div>
                                <label class="input-label">Trust & Safety Fee</label>
                                <div class="input-wrapper">
                                    <span class="input-prefix">$</span>
                                    <input type="number" id="trustSafetyFee" value="${currentInputs.trustSafetyFee}" onchange="state.trustSafetyFee = this.value; render();" placeholder="0.00" step="0.01" class="input-field" />
                                </div>
                            </div>
                            <div>
                                <label class="input-label">Contractor Payout</label>
                                <div class="input-wrapper">
                                    <span class="input-prefix">$</span>
                                    <input type="number" id="contractorPayout" value="${currentInputs.contractorPayout}" onchange="state.contractorPayout = this.value; render();" placeholder="0.00" step="0.01" class="input-field" />
                                </div>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <h3 class="subsection-title">Job Completion</h3>
                                <div class="stat-box indigo">
                                    ${state.isComplete ? `
                                        <div class="stat-value indigo">${jobCompletion}%</div>
                                        <div class="progress-bar">
                                            <div class="progress-fill indigo" style="width: ${jobCompletion}%"></div>
                                        </div>
                                    ` : `
                                        <div class="stat-pending">Pending</div>
                                    `}
                                </div>
                            </div>

                            <div>
                                <h3 class="subsection-title">Refund %</h3>
                                <div class="stat-box red">
                                    ${state.isComplete ? `
                                        <div class="stat-value red">${refundPercentage}%</div>
                                        <div class="progress-bar">
                                            <div class="progress-fill red" style="width: ${refundPercentage}%"></div>
                                        </div>
                                    ` : `
                                        <div class="stat-pending">Pending</div>
                                    `}
                                </div>
                            </div>
                        </div>

                        <div class="grid-2" style="margin-top: 2rem;">
                            <div>
                                <h3 class="subsection-title">Customer Credit Amount</h3>
                                <div class="stat-box green">
                                    ${state.isComplete ? `
                                        <div class="stat-value green">$${customerCreditAmount.toFixed(2)}</div>
                                    ` : `
                                        <div class="stat-pending">Pending</div>
                                    `}
                                </div>
                            </div>

                            <div>
                                <h3 class="subsection-title">Provider Debit Amount</h3>
                                <div class="stat-box orange">
                                    ${state.isComplete ? `
                                        <div class="stat-value orange">$${providerDebitAmount.toFixed(2)}</div>
                                    ` : `
                                        <div class="stat-pending">Pending</div>
                                    `}
                                </div>
                            </div>
                        </div>

                        ${state.isComplete && refundPercentage === 0 ? `
                            <div class="message-box blue">
                                <p class="message-text blue">
                                    Awesome! All quoted work was completed.
                                </p>
                            </div>
                        ` : ''}

                        ${state.isComplete && jobCompletion > 0 && jobCompletion < 100 ? `
                            <div class="message-box yellow">
                                <p class="message-text yellow">
                                    Partial Refund: Please manually credit the customer and manually debit the Pro.
                                </p>
                            </div>
                        ` : ''}

                        ${state.isComplete && jobCompletion === 0 ? `
                            <div class="message-box red">
                                <p class="message-text red">
                                    Full Refund: Please use the "Credit/Pull Payout" in Admin.
                                </p>
                            </div>
                        ` : ''}

                        ${state.isComplete && customerCreditAmount > 75 ? `
                            <div class="message-box purple">
                                <p class="message-text purple">
                                    Customer credit amount is over $75. Please reach out to the Escalations team for approval.
                                </p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        render();
    </script>
</body>
</html>
